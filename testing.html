<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cultivation Intel Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Peer dependencies for Recharts -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/react-is@18.2.0/umd/react-is.production.min.js"></script>
    <!-- Recharts -->
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        html { font-size: 17.33px; } 

        body { 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden; 
            background-color: #020617; /* Deepest Midnight */
            color: #f1f5f9;
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        .recharts-cartesian-grid-horizontal line, .recharts-cartesian-grid-vertical line {
            stroke: #334155;
            opacity: 0.4;
        }
        
        .performance-card { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            background-color: #0f172a; /* Slate 900 */
            border: 1px solid #1e293b; /* Slate 800 */
        }
        .performance-card:hover { 
            transform: translateY(-4px); 
            border-color: #334155;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
        }

        .text-slate-400 { color: #94a3b8 !important; } 
        .text-slate-500 { color: #e2e8f0 !important; }
        
        input, select {
            background-color: #1e293b;
            border: 1px solid #334155;
            color: #f8fafc;
        }

        .recharts-default-tooltip {
            background-color: #0f172a !important;
            border: 1px solid #334155 !important;
            border-radius: 12px !important;
        }
        
        .text-outline {
            text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
        }
    </style>
</head>
<body class="transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const SYSTEM_CONFIG = {
            REAL_DATA_LINK: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQjdT4a3JQRupgfUPALvEidouA-90MjaKNMjXm0TSA_1qJDXD41s186RSIP3jXKlvVjKNvy62E3a2mA/pub?gid=1310781873&single=true&output=csv",
            SAMPLE_DATA_LINK: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQXPdEuZGT4Ipcf2HWXKoIti9IJyh3zR6CrdcW6O-i04WOiuGhHD0YAFlU5JN8XhYWNzcDBskCNX72M/pub?gid=731339314&single=true&output=csv",
            ENTRY_FORM_LINK: "https://forms.gle/ojBK6FsFKCnrp6m46" 
        };

        const COLORS = ['#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316', '#14b8a6', '#6366f1'];
        const KG_TO_LB = 2.20462;

        const { useState, useMemo, useEffect, useRef } = React;
        const { 
            BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, 
            Cell, LineChart, Line, Legend, AreaChart, Area,
            ReferenceLine, ComposedChart, ScatterChart, Scatter
        } = Recharts;

        const Icons = {
            Globe: () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1 4-10z"/></svg>,
            Zap: () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            Scale: () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m16 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="m2 16 3-8 3 8c-.87.65-1.92 1-3 1s-2.13-.35-3-1Z"/><path d="M7 21h10"/><path d="M12 3v18"/><path d="M3 7h18"/></svg>,
            Award: () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></svg>,
            Dollar: () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>,
            Refresh: ({ animate }) => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={animate ? "animate-spin" : ""}><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><polyline points="21 3 21 8 16 8"/></svg>,
            X: () => <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Plus: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            EyeOff: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.52 13.52 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" y1="2" x2="22" y2="22"/></svg>,
            Eye: () => <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>,
            Chevron: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"/></svg>,
            Coins: () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18.06"/><path d="M7 6h1v4"/><path d="M17 12h1v4"/></svg>,
            Crown: () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></svg>,
            List: () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6" /><line x1="8" y1="12" x2="21" y2="12" /><line x1="8" y1="18" x2="21" y2="18" /><line x1="3" y1="6" x2="3.01" y2="6" /><line x1="3" y1="12" x2="3.01" y2="12" /><line x1="3" y1="18" x2="3.01" y2="18" /></svg>,
            Settings: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Trophy: () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
            Target: () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
            Calculator: () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            TrendingUp: () => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
            Trash: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            Info: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>,
            ArrowUp: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg>,
            ArrowDown: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></svg>,
            Star: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
        };

        const MultiSelect = ({ label, options, selected, onChange }) => {
            const [isOpen, setIsOpen] = useState(false);
            const wrapperRef = useRef(null);
            useEffect(() => {
                const handleClickOutside = (event) => { if (wrapperRef.current && !wrapperRef.current.contains(event.target)) setIsOpen(false); };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);
            return (
                <div className="relative flex-1 bg-slate-100 rounded-xl border border-slate-200 shadow-inner px-3 py-1.5 flex items-center gap-2 min-w-[120px]" ref={wrapperRef}>
                    <span className="text-[10px] font-black text-slate-900 uppercase whitespace-nowrap">{label}:</span>
                    <button onClick={() => setIsOpen(!isOpen)} className="flex-1 bg-white border border-slate-300 text-slate-900 text-[12px] font-black px-2 py-0.5 rounded-md uppercase flex items-center justify-between shadow-sm hover:border-emerald-500 transition-all outline-none">
                        <span className="truncate mr-1.5">{selected === 'All' ? 'All' : selected}</span>
                        <Icons.Chevron />
                    </button>
                    {isOpen && (
                        <div className="absolute top-full left-0 w-full mt-1 bg-white border border-slate-200 rounded-lg shadow-xl z-[200] max-h-64 overflow-y-auto custom-scrollbar p-1">
                            {options.map(opt => (
                                <div key={opt} onClick={() => { onChange(opt); setIsOpen(false); }} className={`px-2 py-1.5 text-[10px] font-bold uppercase cursor-pointer rounded hover:bg-slate-100 ${selected === opt ? 'text-emerald-600 bg-emerald-50' : 'text-slate-900'}`}>
                                    {opt}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const SortableTable = ({ columns, data, showTotals = true }) => {
            const [sortConfig, setSortConfig] = useState({ key: null, direction: 'desc' });

            const sortedData = useMemo(() => {
                let sortableItems = [...data];
                if (sortConfig.key !== null) {
                    sortableItems.sort((a, b) => {
                        let aVal = a[sortConfig.key];
                        let bVal = b[sortConfig.key];
                        // Convert currency/weight strings to numbers for sorting
                        const clean = (val) => parseFloat(String(val).replace(/[^0-9.-]/g, ''));
                        if (!isNaN(clean(aVal)) && !isNaN(clean(bVal))) { aVal = clean(aVal); bVal = clean(bVal); }
                        if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1;
                        if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }
                return sortableItems;
            }, [data, sortConfig]);

            const totals = useMemo(() => {
                if (!showTotals) return null;
                const t = {};
                columns.forEach(col => {
                    if (col.isNumeric) {
                        const sum = data.reduce((acc, row) => {
                            const val = parseFloat(String(row[col.key]).replace(/[^0-9.-]/g, ''));
                            return acc + (isNaN(val) ? 0 : val);
                        }, 0);
                        t[col.key] = col.format ? col.format(sum.toFixed(col.decimals || 1)) : sum.toFixed(col.decimals || 1);
                    } else if (col.key === columns[0].key) {
                        t[col.key] = "TOTALS";
                    }
                });
                return t;
            }, [data, columns, showTotals]);

            const requestSort = (key) => {
                let direction = 'desc';
                if (sortConfig.key === key && sortConfig.direction === 'desc') direction = 'asc';
                setSortConfig({ key, direction });
            };

            return (
                <div className="overflow-x-auto custom-scrollbar">
                    <table className="w-full text-left">
                        <thead>
                            <tr className="text-[11px] font-black text-slate-500 uppercase tracking-widest border-b border-slate-800">
                                {columns.map((col) => (
                                    <th key={col.key} onClick={() => requestSort(col.key)} className={`pb-3 cursor-pointer hover:text-emerald-500 transition-colors ${col.align === 'right' ? 'text-right' : 'text-left'}`}>
                                        <div className={`flex items-center gap-1 ${col.align === 'right' ? 'justify-end' : 'justify-start'}`}>
                                            {col.label}
                                            {sortConfig.key === col.key && (sortConfig.direction === 'asc' ? <Icons.ArrowUp /> : <Icons.ArrowDown />)}
                                        </div>
                                    </th>
                                ))}
                            </tr>
                        </thead>
                        <tbody className="text-[13px] font-bold text-slate-300">
                            {sortedData.map((row, idx) => (
                                <tr key={idx} className="border-b border-slate-800/30 last:border-0 hover:bg-slate-800/10">
                                    {columns.map((col) => (
                                        <td key={col.key} className={`py-3 ${col.align === 'right' ? 'text-right' : 'text-left'} ${col.color ? col.color(row) : ''}`}>
                                            {col.format ? col.format(row[col.key], row) : row[col.key]}
                                        </td>
                                    ))}
                                </tr>
                            ))}
                            {totals && (
                                <tr className="border-t-2 border-slate-700/50 bg-slate-800/20">
                                    {columns.map((col) => (
                                        <td key={col.key} className={`py-3 font-black text-white ${col.align === 'right' ? 'text-right' : 'text-left'}`}>
                                            {totals[col.key] || ''}
                                        </td>
                                    ))}
                                </tr>
                            )}
                        </tbody>
                    </table>
                </div>
            );
        };

        const App = () => {
            const [data, setData] = useState([]);
            const [dataSource, setDataSource] = useState('live'); 
            const [isLoading, setIsLoading] = useState(false);
            const [lastSync, setLastSync] = useState('');
            const [matrixMetric, setMatrixMetric] = useState('gpl');
            const [leaderboardSort, setLeaderboardSort] = useState('gpl');
            const [mixChartView, setMixChartView] = useState('ratio');
            const [showEntryModal, setShowEntryModal] = useState(false);
            const [showSettingsModal, setShowSettingsModal] = useState(false);
            const [revenueMode, setRevenueMode] = useState('rpl'); 
            const [targetQuality, setTargetQuality] = useState(70);
            const [expandedCycle, setExpandedCycle] = useState(null);

            // --- EXPANDED SETTINGS STATE ---
            const [prices, setPrices] = useState({ flowerA: 3.97, smallsB: 2.20, trimC: 1.32, bho: 15.00, rosin: 35.00, cart: 18.00, preroll: 4.00 });
            const [strainPrices, setStrainPrices] = useState({});
            const [expenses, setExpenses] = useState([{ id: 1, name: 'Rent', val: 5000 }, { id: 2, name: 'Electric', val: 3500 }, { id: 3, name: 'Labor', val: 8000 }, { id: 4, name: 'Nutrients', val: 1500 }]);
            const [totalActiveLights, setTotalActiveLights] = useState(120); 

            // Forecast & Optimizer State
            const [forecastStrain, setForecastStrain] = useState('');
            const [forecastLights, setForecastLights] = useState(24);
            const [optimizeCount, setOptimizeCount] = useState(5);
            const [forecastCycles, setForecastCycles] = useState([]); 
            const [optimizeMode, setOptimizeMode] = useState('profit'); // 'profit' or 'yield'

            // Consistency Matrix State
            const [consistencyMetric, setConsistencyMetric] = useState('yield'); // 'yield' or 'quality'
            const [minBatchCount, setMinBatchCount] = useState(2);

            const [selectedCycle, setSelectedCycle] = useState('All');
            const [selectedRoom, setSelectedRoom] = useState('All');
            const [selectedStrain, setSelectedStrain] = useState('All');

            // --- COMPARATOR STATE (MULTI) ---
            const [compMode, setCompMode] = useState('cycle'); 
            const [compSelections, setCompSelections] = useState([{ id: 1, cycle: '', room: '' }, { id: 2, cycle: '', room: '' }, { id: 3, cycle: '', room: '' }]);

            // --- COMPUTED OPEX PER LIGHT ---
            const computedOpexPerLight = useMemo(() => {
                const totalFixed = expenses.reduce((acc, curr) => acc + curr.val, 0);
                return totalActiveLights > 0 ? (totalFixed / totalActiveLights).toFixed(2) : 0;
            }, [expenses, totalActiveLights]);

            // --- HELPERS ---
            const addComparison = () => { if (compSelections.length < 9) setCompSelections([...compSelections, { id: Date.now(), cycle: '', room: '' }]); };
            const removeComparison = (id) => { if (compSelections.length > 1) setCompSelections(compSelections.filter(c => c.id !== id)); };
            const updateComparison = (id, field, value) => { setCompSelections(compSelections.map(c => c.id === id ? { ...c, [field]: value } : c)); };
            const addExpense = () => setExpenses([...expenses, { id: Date.now(), name: 'New Expense', val: 0 }]);
            const updateExpense = (id, field, value) => setExpenses(expenses.map(e => e.id === id ? { ...e, [field]: value } : e));
            const removeExpense = (id) => setExpenses(expenses.filter(e => e.id !== id));
            const updateStrainPrice = (strain, price) => setStrainPrices({ ...strainPrices, [strain]: parseFloat(price) });
            const parseCSV = (text) => { const lines = text.split(/\r?\n/).filter(line => line.trim()); if (lines.length < 2) return []; const clean = (val) => (val || "").replace(/^"|"$/g, '').trim(); const splitLine = (line) => { const result = []; let current = ''; let inQuotes = false; for (let i = 0; i < line.length; i++) { const char = line[i]; if (char === '"') inQuotes = !inQuotes; else if (char === ',' && !inQuotes) { result.push(clean(current)); current = ''; } else { current += char; } } result.push(clean(current)); return result; }; const headers = splitLine(lines[0]); return headers.length > 0 ? lines.slice(1).map(line => { const values = splitLine(line); const obj = {}; headers.forEach((h, i) => { obj[h] = values[i]; }); return mapCsvToData(obj); }).filter(d => d["Cycle ID"] !== "N/A" && d["Strain Name"] !== "Unknown" && d["Total Yield (G)"] > 0) : []; };
            const mapCsvToData = (row) => { const num = (val) => { const p = parseFloat(String(val).replace(/[^0-9.]/g, '')); return isNaN(p) ? 0 : p; }; const a = num(row["Flower (A)"] || row["Flower A"] || row["Premium"]); const b = num(row["Smalls (B)"] || row["Smalls B"] || row["Smalls"]); const c = num(row["Trim (C)"] || row["Trim C"] || row["Trim"]); const lights = num(row["Lights"] || row["Light Count"]) || 24; const net = a + b + c; return { "Cycle ID": row["Cycle ID"] || "N/A", "Room ID": row["Room ID"] || "N/A", "Strain Name": row["Strain Name"] || "Unknown", "Flower (A)": a, "Smalls (B)": b, "Trim (C)": c, "Total Yield (G)": net, "Lights": lights, "Grams per Light": net > 0 ? Number((net / lights).toFixed(2)) : 0 }; };
            const autoFetch = async (url) => { setIsLoading(true); try { const finalUrl = `${url}${url.includes('?') ? '&' : '?'}cb=${Date.now()}`; const response = await fetch(finalUrl); const text = await response.text(); const parsed = parseCSV(text); if (parsed.length > 0) { setData(parsed); setLastSync(new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })); } } catch (e) { console.error(e); } finally { setIsLoading(false); } };
            const fetchLink = useMemo(() => dataSource === 'live' ? SYSTEM_CONFIG.REAL_DATA_LINK : SYSTEM_CONFIG.SAMPLE_DATA_LINK, [dataSource]);
            useEffect(() => { autoFetch(fetchLink); }, [fetchLink]);
            const cycleOptions = useMemo(() => ['All', ...[...new Set(data.map(d => String(d["Cycle ID"])))].sort((a,b) => a.localeCompare(b, undefined, {numeric: true}))], [data]);
            const roomOptions = useMemo(() => ['All', ...[...new Set(data.map(d => String(d["Room ID"])))].sort()], [data]);
            const strainOptions = useMemo(() => ['All', ...[...new Set(data.map(d => String(d["Strain Name"])))].sort()], [data]);
            const filteredData = useMemo(() => { return data.filter(item => { const cMatch = selectedCycle === 'All' || item["Cycle ID"] === selectedCycle; const rMatch = selectedRoom === 'All' || item["Room ID"] === selectedRoom; const sMatch = selectedStrain === 'All' || item["Strain Name"] === selectedStrain; return cMatch && rMatch && sMatch; }); }, [data, selectedCycle, selectedRoom, selectedStrain]);

            // --- STATS ---
            const stats = useMemo(() => {
                let totalRev = 0, totalLights = 0, sumA = 0, sumB = 0, sumC = 0, sumNet = 0;
                filteredData.forEach(d => {
                    sumA += d["Flower (A)"]; sumB += d["Smalls (B)"]; sumC += d["Trim (C)"]; sumNet += d["Total Yield (G)"]; totalLights += d["Lights"];
                    const strainPrice = strainPrices[d["Strain Name"]] || prices.flowerA;
                    totalRev += (d["Flower (A)"] * strainPrice) + (d["Smalls (B)"] * prices.smallsB) + (d["Trim (C)"] * prices.trimC);
                });
                const totalOpex = totalLights * parseFloat(computedOpexPerLight);
                const netProfit = totalRev - totalOpex;
                const profitMargin = totalRev > 0 ? (netProfit / totalRev) * 100 : 0;
                const lb = (v) => ((v / 1000) * KG_TO_LB).toFixed(1);
                const g = (v) => Math.round(v).toLocaleString();
                return {
                    totalLb: lb(sumNet), totalG: g(sumNet), flowerA_Lb: lb(sumA), flowerA_G: g(sumA), smallsB_Lb: lb(sumB), smallsB_G: g(sumB), trimC_Lb: lb(sumC), trimC_G: g(sumC),
                    gpl: totalLights > 0 ? (sumNet / totalLights).toFixed(1) : 0, flowerGpl: totalLights > 0 ? (sumA / totalLights).toFixed(1) : 0, smallsGpl: totalLights > 0 ? (sumB / totalLights).toFixed(1) : 0, trimGpl: totalLights > 0 ? (sumC / totalLights).toFixed(1) : 0,
                    rpl: totalLights > 0 ? (totalRev / totalLights).toFixed(2) : 0, flowerRpl: totalLights > 0 ? ((sumA * prices.flowerA) / totalLights).toFixed(2) : 0, smallsRpl: totalLights > 0 ? ((sumB * prices.smallsB) / totalLights).toFixed(2) : 0, trimRpl: totalLights > 0 ? ((sumC * prices.trimC) / totalLights).toFixed(2) : 0,
                    revA: Math.round(sumA * prices.flowerA).toLocaleString(), revB: Math.round(sumB * prices.smallsB).toLocaleString(), revC: Math.round(sumC * prices.trimC).toLocaleString(),
                    quality: sumNet > 0 ? ((sumA / sumNet) * 100).toFixed(1) : "0", smallsRatio: sumNet > 0 ? ((sumB / sumNet) * 100).toFixed(1) : "0", trimRatio: sumNet > 0 ? ((sumC / sumNet) * 100).toFixed(1) : "0",
                    revenue: Math.round(totalRev).toLocaleString(), netProfit: Math.round(netProfit).toLocaleString(), profitMargin: profitMargin.toFixed(1), opexTotal: Math.round(totalOpex).toLocaleString()
                };
            }, [filteredData, prices, strainPrices, computedOpexPerLight]);

            // --- DATA TRANSFORMATIONS ---
            const scatterData = useMemo(() => filteredData.map((d, i) => { const net = d["Total Yield (G)"] || 0; const flr = d["Flower (A)"] || 0; return { x: d["Grams per Light"] || 0, y: net > 0 ? Number(((flr / net) * 100).toFixed(1)) : 0, lpl: (d["Grams per Light"] / 453.592).toFixed(2), name: d["Strain Name"], cycle: d["Cycle ID"], room: d["Room ID"], id: i }; }), [filteredData]);
            const roomBenchmark = useMemo(() => {
                const map = {};
                filteredData.forEach(d => {
                    const r = d["Room ID"];
                    if (!map[r]) map[r] = { name: r, gplSum: 0, premiumSum: 0, usableSum: 0, count: 0 };
                    map[r].gplSum += d["Grams per Light"]; map[r].premiumSum += d["Flower (A)"]; map[r].usableSum += d["Total Yield (G)"]; map[r].count += 1;
                });
                return Object.values(map).map(m => ({ name: m.name, gpl: Number((m.gplSum / m.count).toFixed(2)), mix: m.usableSum > 0 ? Number(((m.premiumSum / m.usableSum) * 100).toFixed(1)) : 0 })).map(item => ({...item, sortVal: leaderboardSort === 'mix' ? item.mix : item.gpl})).sort((a,b) => b.sortVal - a.sortVal);
            }, [filteredData, leaderboardSort]);
            
            const strainRoomMatrix = useMemo(() => {
                const strains = selectedStrain === 'All' ? strainOptions.filter(s => s !== 'All') : [selectedStrain];
                const rooms = roomOptions.filter(r => r !== 'All');
                return strains.map(s => {
                    const row = { strain: s, maxVal: 0 };
                    rooms.forEach(r => {
                        const matches = filteredData.filter(d => d["Strain Name"] === s && d["Room ID"] === r);
                        if (matches.length > 0) {
                            const val = matrixMetric === 'gpl' ? Number((matches.reduce((acc, m) => acc + m["Grams per Light"], 0) / matches.length).toFixed(1)) : Number(((matches.reduce((acc, m) => acc + m["Total Yield (G)"], 0) / 1000) * KG_TO_LB).toFixed(1));
                            row[r] = val;
                            if (val > row.maxVal) row.maxVal = val;
                        } else row[r] = '-';
                    });
                    return row;
                });
            }, [filteredData, roomOptions, strainOptions, selectedStrain, matrixMetric]);

            const cycleBreakdown = useMemo(() => {
                const groups = {};
                filteredData.forEach(d => {
                    const cid = d["Cycle ID"];
                    if (!groups[cid]) groups[cid] = { id: cid, rooms: [], totalYieldG: 0, totalLights: 0, totalPremiumG: 0, strains: {}, roomsAgg: {} };
                    const rowData = { id: d["Room ID"], strain: d["Strain Name"], yieldG: d["Total Yield (G)"], premiumG: d["Flower (A)"], lights: d["Lights"], gpl: d["Grams per Light"] };
                    groups[cid].rooms.push(rowData);
                    groups[cid].totalYieldG += d["Total Yield (G)"]; groups[cid].totalLights += d["Lights"]; groups[cid].totalPremiumG += d["Flower (A)"];
                    const s = d["Strain Name"];
                    if (!groups[cid].strains[s]) groups[cid].strains[s] = { name: s, yieldG: 0, premiumG: 0, lights: 0 };
                    groups[cid].strains[s].yieldG += d["Total Yield (G)"]; groups[cid].strains[s].premiumG += d["Flower (A)"]; groups[cid].strains[s].lights += d["Lights"];
                    const r = d["Room ID"];
                    if (!groups[cid].roomsAgg[r]) groups[cid].roomsAgg[r] = { name: r, yieldG: 0, premiumG: 0, lights: 0, strains: new Set() };
                    groups[cid].roomsAgg[r].yieldG += d["Total Yield (G)"]; groups[cid].roomsAgg[r].premiumG += d["Flower (A)"]; groups[cid].roomsAgg[r].lights += d["Lights"]; groups[cid].roomsAgg[r].strains.add(d["Strain Name"]);
                });
                return Object.values(groups).map(g => {
                    const yieldLb = (g.totalYieldG / 1000) * KG_TO_LB; const flowerLb = (g.totalPremiumG / 1000) * KG_TO_LB;
                    return {
                        id: g.id, yieldLb: yieldLb.toFixed(1), flowerLb: flowerLb.toFixed(1), gpl: g.totalLights > 0 ? (g.totalYieldG / g.totalLights).toFixed(1) : 0, quality: g.totalYieldG > 0 ? ((g.totalPremiumG / g.totalYieldG) * 100).toFixed(1) : 0,
                        rooms: g.rooms.map(r => ({ id: r.id, strain: r.strain, yieldLb: ((r.yieldG / 1000) * KG_TO_LB).toFixed(1), flowerLb: ((r.premiumG / 1000) * KG_TO_LB).toFixed(1), gpl: r.gpl.toFixed(1), quality: r.yieldG > 0 ? ((r.premiumG / r.yieldG) * 100).toFixed(1) : 0 })).sort((a,b) => a.id.localeCompare(b.id, undefined, {numeric: true})),
                        strainsAgg: Object.values(g.strains).map(s => ({ name: s.name, yieldLb: ((s.yieldG / 1000) * KG_TO_LB).toFixed(1), flowerLb: ((s.premiumG / 1000) * KG_TO_LB).toFixed(1), gpl: s.lights > 0 ? (s.yieldG / s.lights).toFixed(1) : 0, quality: s.yieldG > 0 ? ((s.premiumG / s.yieldG) * 100).toFixed(1) : 0 })),
                        roomsAgg: Object.values(g.roomsAgg).map(r => ({ name: r.name, yieldLb: ((r.yieldG / 1000) * KG_TO_LB).toFixed(1), flowerLb: ((r.premiumG / 1000) * KG_TO_LB).toFixed(1), strains: Array.from(r.strains).join(', '), gpl: r.lights > 0 ? (r.yieldG / r.lights).toFixed(1) : 0, quality: r.yieldG > 0 ? ((r.premiumG / r.yieldG) * 100).toFixed(1) : 0 }))
                    };
                }).sort((a,b) => a.id.localeCompare(b.id, undefined, {numeric: true})); 
            }, [filteredData]);

            // --- COMPARATOR ---
            const getCompStats = (selection) => {
                let subset = [];
                if (!selection.cycle && !selection.room) return null;
                if (compMode === 'cycle') { if (!selection.cycle) return null; subset = data.filter(d => d["Cycle ID"] === selection.cycle); }
                else if (compMode === 'room') { if (!selection.room) return null; subset = data.filter(d => d["Room ID"] === selection.room); }
                else if (compMode === 'batch') { if (!selection.cycle || !selection.room) return null; subset = data.filter(d => d["Cycle ID"] === selection.cycle && d["Room ID"] === selection.room); }
                if (subset.length === 0) return null;
                const lights = subset.reduce((acc, d) => acc + d["Lights"], 0) || 1;
                const totalYield = subset.reduce((acc, d) => acc + d["Total Yield (G)"], 0);
                const premium = subset.reduce((acc, d) => acc + d["Flower (A)"], 0);
                const totalRev = subset.reduce((acc, d) => (d["Flower (A)"] * (strainPrices[d["Strain Name"]] || prices.flowerA)) + (d["Smalls (B)"] * prices.smallsB) + (d["Trim (C)"] * prices.trimC), 0);
                return {
                    yieldLb: ((totalYield / 1000) * KG_TO_LB).toFixed(1), flowerLb: ((premium / 1000) * KG_TO_LB).toFixed(1), gpl: (totalYield / lights).toFixed(1),
                    quality: totalYield > 0 ? ((premium / totalYield) * 100).toFixed(1) : "0", revenue: totalRev, rpl: (totalRev / lights).toFixed(2)
                };
            };
            const computedComparisons = useMemo(() => compSelections.map(s => ({ ...s, stats: getCompStats(s) })), [compSelections, compMode, data, prices, strainPrices]);
            const compMaxValues = useMemo(() => {
                const stats = computedComparisons.filter(c => c.stats).map(c => c.stats);
                if (stats.length < 2) return {};
                return { gpl: Math.max(...stats.map(s => parseFloat(s.gpl))), flowerLb: Math.max(...stats.map(s => parseFloat(s.flowerLb))), quality: Math.max(...stats.map(s => parseFloat(s.quality))), rpl: Math.max(...stats.map(s => parseFloat(s.rpl))) };
            }, [computedComparisons]);

            // --- FORECAST & OPTIMIZER ---
            const forecastResult = useMemo(() => {
                if (!forecastStrain || !forecastLights) return null;
                const history = data.filter(d => d["Strain Name"] === forecastStrain && (forecastCycles.length === 0 || forecastCycles.includes(d["Cycle ID"])));
                if (history.length === 0) return null;
                const gpls = history.map(d => d["Grams per Light"]);
                const avgGpl = gpls.reduce((a,b) => a+b, 0) / gpls.length;
                const squareDiffs = gpls.map(v => Math.pow(v - avgGpl, 2));
                const stdDev = Math.sqrt(squareDiffs.reduce((a,b) => a+b, 0) / gpls.length);
                const calcRevenue = (gpl) => { const totalG = gpl * forecastLights; const price = strainPrices[forecastStrain] || prices.flowerA; return (totalG * 0.7 * price) + (totalG * 0.2 * prices.smallsB) + (totalG * 0.1 * prices.trimC); };
                return { avgGpl: avgGpl.toFixed(0), lowWt: (((avgGpl-stdDev)*forecastLights/1000)*KG_TO_LB).toFixed(1), highWt: (((avgGpl+stdDev)*forecastLights/1000)*KG_TO_LB).toFixed(1), estRevenue: Math.round(calcRevenue(avgGpl)).toLocaleString() };
            }, [forecastStrain, forecastLights, forecastCycles, data, prices, strainPrices]);

            const optimizerResults = useMemo(() => {
                const strainStats = {};
                data.forEach(d => {
                    const s = d["Strain Name"];
                    if (!strainStats[s]) strainStats[s] = { name: s, count: 0, totalGpl: 0, totalA: 0, totalG: 0 };
                    strainStats[s].count++; strainStats[s].totalGpl += d["Grams per Light"]; strainStats[s].totalA += d["Flower (A)"]; strainStats[s].totalG += d["Total Yield (G)"];
                });
                return Object.values(strainStats).map(s => {
                    const avgGpl = s.totalGpl / s.count; const avgRatioA = s.totalA / s.totalG; const price = strainPrices[s.name] || prices.flowerA;
                    const estRevPerLight = (avgGpl * avgRatioA * price) + (avgGpl * (1-avgRatioA) * prices.smallsB);
                    const estProfit = estRevPerLight - parseFloat(computedOpexPerLight);
                    return { name: s.name, avgGpl: avgGpl.toFixed(0), estProfit: estProfit.toFixed(0), roi: estRevPerLight > 0 ? ((estProfit / estRevPerLight) * 100).toFixed(1) : 0, avgRatioA: (avgRatioA*100).toFixed(1) };
                }).sort((a,b) => optimizeMode === 'profit' ? b.estProfit - a.estProfit : b.avgGpl - a.avgGpl).slice(0, optimizeCount);
            }, [data, prices, strainPrices, computedOpexPerLight, optimizeCount, optimizeMode]);

            // --- CONSISTENCY ---
            const consistencyData = useMemo(() => {
                const map = {};
                data.forEach(d => { const s = d["Strain Name"]; if (!map[s]) map[s] = { name: s, vals: [] }; map[s].vals.push(consistencyMetric === 'yield' ? d["Grams per Light"] : (d["Total Yield (G)"]>0 ? (d["Flower (A)"]/d["Total Yield (G)"])*100 : 0)); });
                return Object.values(map).filter(m => m.vals.length >= minBatchCount).map(m => {
                    const avg = m.vals.reduce((a,b) => a+b, 0) / m.vals.length;
                    const squareDiffs = m.vals.map(v => Math.pow(v - avg, 2));
                    const stdDev = Math.sqrt(squareDiffs.reduce((a,b) => a+b, 0) / squareDiffs.length);
                    return { name: m.name, x: Number(avg.toFixed(1)), y: Number(stdDev.toFixed(1)), count: m.vals.length };
                });
            }, [data, consistencyMetric, minBatchCount]);

            // --- HALL OF FAME ---
            const hallOfFame = useMemo(() => {
                if (data.length === 0) return null;
                const bestYield = [...data].sort((a,b) => b["Flower (A)"] - a["Flower (A)"])[0];
                const bestGpl = [...data].sort((a,b) => b["Grams per Light"] - a["Grams per Light"])[0];
                const bestQuality = [...data].filter(d => d["Total Yield (G)"] > 1000).map(d => ({...d, qRatio: (d["Flower (A)"] / d["Total Yield (G)"])})).sort((a,b) => b.qRatio - a.qRatio)[0];
                return {
                    yield: { val: ((bestYield["Flower (A)"]/1000)*KG_TO_LB).toFixed(1), total: ((bestYield["Total Yield (G)"]/1000)*KG_TO_LB).toFixed(1), room: bestYield["Room ID"], cycle: bestYield["Cycle ID"], strain: bestYield["Strain Name"] },
                    gpl: { val: bestGpl["Grams per Light"], room: bestGpl["Room ID"], cycle: bestGpl["Cycle ID"], strain: bestGpl["Strain Name"] },
                    quality: { val: (bestQuality.qRatio * 100).toFixed(1), room: bestQuality["Room ID"], cycle: bestQuality["Cycle ID"], strain: bestQuality["Strain Name"] }
                };
            }, [data]);

            return (
                <div className="min-h-screen bg-slate-950 text-slate-100 transition-all duration-500 pb-32">
                    {/* Header */}
                    <div className="sticky top-0 z-[100] bg-slate-900 border-b border-slate-800 px-4 py-3 shadow-xl">
                        <div className="max-w-screen-2xl mx-auto flex items-center justify-between gap-4">
                            <div className="flex items-center gap-4 shrink-0">
                                <div className="flex items-center gap-3 pr-3 border-r border-slate-800 shrink-0">
                                    <div className="bg-emerald-600 p-1.5 rounded-xl text-white shadow-md"><Icons.Globe /></div>
                                    <div className="flex flex-col leading-none"><h1 className="text-[12px] font-black italic uppercase tracking-tighter">Cultivation Intel</h1><div className="flex items-center gap-1.5 mt-1 leading-none"><span className="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span><p className="text-[10px] font-black uppercase text-slate-400">SYNC: {lastSync || 'Pending'}</p></div></div>
                                </div>
                                <div className="flex items-center gap-1 bg-slate-800 p-0.5 rounded-lg border border-slate-700">
                                    <button onClick={() => setDataSource('live')} className={`px-2 py-1 text-[9px] font-black uppercase rounded-md transition-all ${dataSource === 'live' ? 'bg-slate-700 shadow-sm text-emerald-500' : 'text-slate-500 hover:text-slate-300'}`}>Live</button>
                                    <button onClick={() => setDataSource('sample')} className={`px-2 py-1 text-[9px] font-black uppercase rounded-md transition-all ${dataSource === 'sample' ? 'bg-slate-700 shadow-sm text-emerald-500' : 'text-slate-400 hover:text-slate-300'}`}>Demo</button>
                                </div>
                            </div>
                            <div className="flex items-center gap-3 overflow-x-auto no-scrollbar mask-gradient flex-1 justify-center">
                                <MultiSelect label="Cyc" options={cycleOptions} selected={selectedCycle} onChange={setSelectedCycle} />
                                <MultiSelect label="Rm" options={roomOptions} selected={selectedRoom} onChange={setSelectedRoom} />
                                <MultiSelect label="Str" options={strainOptions} selected={selectedStrain} onChange={setSelectedStrain} />
                            </div>
                            <div className="flex items-center gap-2 shrink-0">
                                <button onClick={() => setShowEntryModal(true)} className="bg-emerald-600 text-white p-2 rounded-xl shadow-md hover:bg-emerald-700 active:scale-95 flex items-center gap-2 font-black text-[10px] uppercase transition-all"><Icons.Plus /> Entry</button>
                                <button onClick={() => autoFetch(fetchLink)} className={`p-2 rounded-xl transition-all shadow-md bg-slate-800 hover:bg-slate-700 text-white`}><Icons.Refresh animate={isLoading} /></button>
                                <button onClick={() => setShowSettingsModal(true)} className={`p-2 rounded-xl transition-all shadow-md bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white`}><Icons.Settings /></button>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-screen-2xl mx-auto p-4 md:p-8 text-center flex flex-col gap-12">
                        {/* KPI GRID */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 text-left">
                            <div className={`p-9 rounded-[3rem] shadow-sm performance-card overflow-hidden group`}>
                                <div className="flex justify-between items-start mb-8 leading-none">
                                    <div><p className="text-slate-400 text-[12px] font-black uppercase tracking-widest mb-1 group-hover:text-emerald-500">Net Usable Harvest</p><h3 className="text-[38px] font-black tracking-tighter italic leading-none text-slate-100">{stats.totalLb}<span className="text-[17px] font-normal text-slate-400 ml-1 italic text-[16px]">lb</span></h3><p className="text-[11px] font-bold text-slate-500/60 mt-2 uppercase tracking-wide">({stats.totalG}g total)</p></div><div className="p-5 rounded-2xl bg-emerald-500 text-white shadow-lg"><Icons.Scale /></div>
                                </div>
                                <div className="space-y-5 border-t border-slate-800 pt-8">
                                    {[{ l: 'FLOWER (A)', v: stats.flowerA_Lb, g: stats.flowerA_G, c: 'text-emerald-500', bg: 'bg-emerald-500/10' }, { l: 'SMALLS (B)', v: stats.smallsB_Lb, g: stats.smallsB_G, c: 'text-blue-500', bg: 'bg-blue-500/10' }, { l: 'TRIM (C)', v: stats.trimC_Lb, g: stats.trimC_G, c: 'text-amber-600', bg: 'bg-amber-500/10' }].map(b => ( <div key={b.l} className={`flex items-center justify-between p-4 rounded-2xl ${b.bg} border border-slate-800 shadow-sm`}><p className="text-[11px] font-black text-slate-400 tracking-tighter uppercase">{b.l}</p><div className="text-right leading-none"><p className={`text-[15px] font-black ${b.c}`}>{b.v}lb</p><p className="text-[10px] font-bold text-slate-500/60 mt-1 uppercase">({b.g}g)</p></div></div> ))}
                                </div>
                            </div>
                            <div className={`p-9 rounded-[3rem] shadow-sm performance-card overflow-hidden group`}>
                                <div className="flex justify-between items-start mb-8 leading-none">
                                    <div><p className="text-slate-400 text-[12px] font-black uppercase tracking-widest mb-1 group-hover:text-blue-500">Efficiency (GPL)</p><h3 className="text-[38px] font-black tracking-tighter italic leading-none text-slate-100">{stats.gpl}<span className="text-[16px] font-normal text-slate-400 ml-1 italic text-[16px]">GPL</span></h3><p className="text-[13px] font-bold text-slate-500 mt-2 uppercase tracking-wide">Industrial Density</p></div><div className="p-5 rounded-2xl bg-blue-500 text-white shadow-lg"><Icons.Zap /></div>
                                </div>
                                <div className="space-y-5 border-t border-slate-800 pt-8">
                                    {[{ l: 'FLOWER GPL', v: stats.flowerGpl, c: 'text-emerald-600', bg: 'bg-emerald-500/10' }, { l: 'SMALLS GPL', v: stats.smallsGpl, c: 'text-blue-500', bg: 'bg-blue-500/10' }, { l: 'TRIM GPL', v: stats.trimGpl, c: 'text-amber-600', bg: 'bg-amber-500/10' }].map(b => ( <div key={b.l} className={`flex items-center justify-between p-4 rounded-2xl ${b.bg} border border-slate-800 shadow-sm`}><p className="text-[11px] font-black text-slate-400 tracking-tighter uppercase">{b.l}</p><p className={`text-[16px] font-black ${b.c}`}>{b.v} GPL</p></div> ))}
                                </div>
                            </div>
                            <div className={`p-9 rounded-[3rem] shadow-sm performance-card overflow-hidden group`}>
                                <div className="flex justify-between items-start mb-8 leading-none">
                                    <div><p className="text-slate-400 text-[12px] font-black uppercase tracking-widest mb-1 group-hover:text-amber-500">Flower Yield Ratio</p><h3 className="text-[38px] font-black tracking-tighter italic leading-none text-slate-100">{stats.quality}<span className="text-[16px] font-normal text-slate-400 ml-1 italic text-[16px]">%</span></h3><p className="text-[13px] font-bold text-slate-500 mt-2 uppercase tracking-wide">Goal: {targetQuality}%</p></div><div className="p-5 rounded-2xl bg-amber-500 text-white shadow-lg"><Icons.Award /></div>
                                </div>
                                <div className="space-y-5 border-t border-slate-800 pt-8">
                                    {[{ l: 'FLOWER %', v: stats.quality, c: 'text-emerald-600', bg: 'bg-emerald-500/10' }, { l: 'SMALLS %', v: stats.smallsRatio, c: 'text-blue-500', bg: 'bg-blue-500/10' }, { l: 'TRIM %', v: stats.trimRatio, c: 'text-amber-600', bg: 'bg-amber-500/10' }].map(b => ( <div key={b.l} className={`flex items-center justify-between p-4 rounded-2xl ${b.bg} border border-slate-800 shadow-sm`}><p className="text-[11px] font-black text-slate-400 tracking-tighter uppercase">{b.l}</p><p className={`text-[15px] font-black ${b.c}`}>{b.v}%</p></div> ))}
                                </div>
                            </div>
                            <div className={`p-9 rounded-[3rem] shadow-sm performance-card overflow-hidden group`}>
                                <div className="flex justify-between items-start mb-8 leading-none">
                                    <div>
                                        <h3 className="text-[32px] font-black tracking-tighter italic leading-none text-slate-100">{revenueMode === 'profit' ? `$${stats.netProfit}` : (revenueMode === 'rpl' ? `$${stats.rpl}` : `$${stats.revenue}`)}<span className="text-[17px] font-normal text-slate-400 ml-1 italic text-[16px]">{revenueMode === 'rpl' ? '/Light' : ''}</span></h3>
                                        <div className="flex items-center gap-3 mt-3"><p className="text-[12px] text-slate-500 font-black uppercase tracking-widest tracking-wide">Financials</p><div className={`flex items-center gap-2 p-1 rounded-lg border border-slate-700 bg-slate-800`}><button onClick={() => setRevenueMode('profit')} className={`px-2 py-1 text-[10px] font-black uppercase rounded ${revenueMode === 'profit' ? 'bg-slate-600 shadow text-emerald-400' : 'text-slate-400'}`}>Net</button><button onClick={() => setRevenueMode('rpl')} className={`px-2 py-1 text-[10px] font-black uppercase rounded ${revenueMode === 'rpl' ? 'bg-slate-600 shadow text-purple-400' : 'text-slate-400'}`}>RPL</button><button onClick={() => setRevenueMode('total')} className={`px-2 py-1 text-[10px] font-black uppercase rounded ${revenueMode === 'total' ? 'bg-slate-600 shadow text-purple-400' : 'text-slate-400'}`}>Gross</button></div></div>
                                    </div>
                                    <div className="p-5 rounded-2xl bg-purple-500 text-white shadow-lg"><Icons.Dollar /></div>
                                </div>
                                <div className="space-y-4 border-t border-slate-800 pt-6">
                                    <div className="flex justify-between items-center group/opex relative cursor-help">
                                         <div className="flex items-center gap-1"><p className="text-[11px] font-black text-slate-400 tracking-tighter uppercase">EST OPEX (@ ${computedOpexPerLight})</p><Icons.Info /></div>
                                         <p className="text-[13px] font-black text-rose-400">-${stats.opexTotal}</p>
                                         <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-48 p-3 bg-slate-800 rounded-xl border border-slate-700 shadow-xl text-[10px] font-bold text-slate-300 opacity-0 group-hover/opex:opacity-100 pointer-events-none transition-opacity z-50">Operational Expenses (Rent, Labor, etc.) are subtracted from Revenue to calculate Profit.</div>
                                    </div>
                                    <div className="flex justify-between items-center"><p className="text-[11px] font-black text-slate-400 tracking-tighter uppercase">PROFIT MARGIN</p><p className={`text-[13px] font-black ${stats.profitMargin > 0 ? 'text-emerald-400' : 'text-rose-400'}`}>{stats.profitMargin}%</p></div>
                                    <div className="flex justify-between items-center pt-2 border-t border-slate-800/50"><p className="text-[11px] font-black text-slate-400 tracking-tighter uppercase">FLOWER REVENUE</p><p className="text-[13px] font-black text-emerald-600">${stats.revA}</p></div>
                                </div>
                            </div>
                        </div>

                        {/* COMPARATOR (3x3 Grid) */}
                        <div className="p-11 rounded-[3.5rem] performance-card text-left relative overflow-hidden mb-8">
                            <div className="flex flex-col md:flex-row md:items-center justify-between mb-10 gap-8 leading-none">
                                <div className="flex items-center gap-5"><div className="bg-purple-500/10 p-4 rounded-2xl text-purple-400"><Icons.Scale /></div><div><h2 className="text-[28px] font-black italic uppercase tracking-tighter leading-none text-slate-100">Performance Face-Off</h2><p className="text-slate-500 text-[14px] font-black uppercase tracking-widest mt-3 italic leading-none">Multi-Select Analysis (Up to 9)</p></div></div>
                                <div className="flex flex-wrap items-center gap-2 bg-slate-800 p-2 rounded-2xl border border-slate-700 shadow-sm">
                                    <button onClick={() => { setCompMode('cycle'); setCompSelections([{ id: 1, cycle: '', room: '' }, { id: 2, cycle: '', room: '' }]); }} className={`px-4 py-2 text-[12px] font-black uppercase rounded-xl transition-all ${compMode === 'cycle' ? 'bg-slate-600 text-white shadow' : 'text-slate-500'}`}>Cycle</button>
                                    <button onClick={() => { setCompMode('room'); setCompSelections([{ id: 1, cycle: '', room: '' }, { id: 2, cycle: '', room: '' }]); }} className={`px-4 py-2 text-[12px] font-black uppercase rounded-xl transition-all ${compMode === 'room' ? 'bg-slate-600 text-white shadow' : 'text-slate-500'}`}>Room</button>
                                    <button onClick={() => { setCompMode('batch'); setCompSelections([{ id: 1, cycle: '', room: '' }, { id: 2, cycle: '', room: '' }]); }} className={`px-4 py-2 text-[12px] font-black uppercase rounded-xl transition-all ${compMode === 'batch' ? 'bg-slate-600 text-white shadow' : 'text-slate-500'}`}>Batch</button>
                                    <div className="h-6 w-px bg-slate-700 mx-2"></div>
                                    <button onClick={addComparison} className="p-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-white transition-colors" disabled={compSelections.length >= 9}><Icons.Plus /></button>
                                </div>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                {computedComparisons.map((item, index) => (
                                    <div key={item.id} className="bg-slate-900/50 rounded-3xl p-6 border border-slate-800/60 relative group">
                                        {compSelections.length > 2 && <button onClick={() => removeComparison(item.id)} className="absolute top-4 right-4 text-slate-600 hover:text-rose-500 opacity-0 group-hover:opacity-100 transition-opacity p-2 bg-slate-900 rounded-xl border border-slate-800"><Icons.Trash /></button>}
                                        <div className="flex flex-col gap-4 mb-8">
                                            <div className="flex items-center gap-2 mb-2"><div className={`w-2 h-2 rounded-full ${index % 2 === 0 ? 'bg-emerald-500' : 'bg-blue-500'}`}></div><p className={`text-[11px] font-black uppercase tracking-widest ${index % 2 === 0 ? 'text-emerald-500' : 'text-blue-500'}`}>Selection {index + 1}</p></div>
                                            {(compMode === 'cycle' || compMode === 'batch') && <select className="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-[13px] font-bold text-white outline-none focus:border-emerald-500 transition-all" value={item.cycle} onChange={(e) => updateComparison(item.id, 'cycle', e.target.value)}><option value="">Select Cycle...</option>{cycleOptions.filter(c => c !== 'All').map(c => <option key={c} value={c}>{c}</option>)}</select>}
                                            {(compMode === 'room' || (compMode === 'batch' && item.cycle)) && <select className="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-[13px] font-bold text-white outline-none focus:border-emerald-500 transition-all" value={item.room} onChange={(e) => updateComparison(item.id, 'room', e.target.value)}><option value="">Select Room...</option>{roomOptions.filter(r => r !== 'All').map(r => <option key={r} value={r}>{r}</option>)}</select>}
                                        </div>
                                        {item.stats ? (
                                            <div className="space-y-6">
                                                <div><p className="text-[10px] font-black uppercase text-slate-500 tracking-widest mb-1">Flower Yield</p><p className={`text-[32px] font-black leading-none ${parseFloat(item.stats.flowerLb) === compMaxValues.flowerLb ? 'text-emerald-400' : 'text-white'}`}>{item.stats.flowerLb} <span className="text-[14px] text-slate-500 font-bold">lb</span></p><p className="text-[11px] font-bold text-slate-600 mt-1 uppercase">Total: {item.stats.yieldLb} lb</p></div>
                                                <div className="grid grid-cols-2 gap-4">
                                                    <div><p className="text-[10px] font-black uppercase text-slate-500 tracking-widest mb-1">Efficiency</p><p className={`text-[18px] font-black ${parseFloat(item.stats.gpl) === compMaxValues.gpl ? 'text-blue-400' : 'text-slate-300'}`}>{item.stats.gpl} GPL</p></div>
                                                    <div><p className="text-[10px] font-black uppercase text-slate-500 tracking-widest mb-1">Quality</p><p className={`text-[18px] font-black ${parseFloat(item.stats.quality) === compMaxValues.quality ? 'text-amber-400' : 'text-slate-300'}`}>{item.stats.quality}%</p></div>
                                                </div>
                                                <div className="pt-6 border-t border-slate-800"><p className="text-[10px] font-black uppercase text-slate-500 tracking-widest mb-1">Revenue Performance</p><div className="flex justify-between items-end"><p className={`text-[20px] font-black ${parseFloat(item.stats.rpl) === compMaxValues.rpl ? 'text-purple-400' : 'text-slate-400'}`}>${item.stats.rpl}/L</p><p className="text-[11px] font-bold text-slate-600">${Math.round(item.stats.revenue / 1000)}k</p></div></div>
                                            </div>
                                        ) : <div className="h-48 flex items-center justify-center text-slate-600 text-[12px] font-bold uppercase tracking-widest italic border-2 border-dashed border-slate-800 rounded-2xl">Select...</div>}
                                    </div>
                                ))}
                            </div>
                        </div>

                        {hallOfFame && (
                            <div className="p-10 rounded-[3rem] bg-gradient-to-r from-amber-500/10 to-transparent border border-amber-500/20 text-left relative overflow-hidden mb-8">
                                <div className="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-8 leading-none">
                                    <div className="flex items-center gap-5"><div className="bg-amber-500 p-4 rounded-2xl text-white shadow-lg shadow-amber-500/20"><Icons.Trophy /></div><div><h2 className="text-[28px] font-black italic uppercase tracking-tighter leading-none text-slate-100">The Hall of Fame</h2><p className="text-slate-400 text-[14px] font-black uppercase tracking-widest mt-3 italic leading-none">All-Time Facility Records</p></div></div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div className="bg-slate-900/60 p-6 rounded-3xl border border-slate-800"><p className="text-[11px] font-black text-amber-500 uppercase tracking-widest mb-2">Highest Flower Yield</p><p className="text-[32px] font-black text-white italic tracking-tighter">{hallOfFame.yield.val} <span className="text-lg text-slate-500 not-italic">lb</span></p><p className="text-[10px] font-bold text-slate-500 mt-1 uppercase mb-3">Total: {hallOfFame.yield.total} lb</p><p className="text-xs text-slate-400 border-t border-slate-800 pt-3 font-bold uppercase">{hallOfFame.yield.strain} <span className="text-slate-600">|</span> {hallOfFame.yield.room} <span className="text-slate-600">|</span> {hallOfFame.yield.cycle}</p></div>
                                    <div className="bg-slate-900/60 p-6 rounded-3xl border border-slate-800"><p className="text-[11px] font-black text-blue-400 uppercase tracking-widest mb-2">Most Efficient Run</p><p className="text-[32px] font-black text-white italic tracking-tighter">{hallOfFame.gpl.val} <span className="text-lg text-slate-500 not-italic">GPL</span></p><p className="text-[10px] font-bold text-slate-500 mt-1 uppercase mb-3 opacity-0">Spacer</p><p className="text-xs text-slate-400 border-t border-slate-800 pt-3 font-bold uppercase">{hallOfFame.gpl.strain} <span className="text-slate-600">|</span> {hallOfFame.gpl.room} <span className="text-slate-600">|</span> {hallOfFame.gpl.cycle}</p></div>
                                    <div className="bg-slate-900/60 p-6 rounded-3xl border border-slate-800"><p className="text-[11px] font-black text-emerald-400 uppercase tracking-widest mb-2">Highest Quality Batch</p><p className="text-[32px] font-black text-white italic tracking-tighter">{hallOfFame.quality.val}<span className="text-lg text-slate-500 not-italic">%</span></p><p className="text-[10px] font-bold text-slate-500 mt-1 uppercase mb-3 opacity-0">Spacer</p><p className="text-xs text-slate-400 border-t border-slate-800 pt-3 font-bold uppercase">{hallOfFame.quality.strain} <span className="text-slate-600">|</span> {hallOfFame.quality.room} <span className="text-slate-600">|</span> {hallOfFame.quality.cycle}</p></div>
                                </div>
                            </div>
                        )}

                        <div className="p-11 rounded-[3.5rem] performance-card text-left">
                            <div className="flex flex-col md:flex-row md:items-center justify-between mb-12 gap-8 leading-none">
                                <div><h2 className="text-[28px] font-black italic uppercase tracking-tighter leading-none text-slate-100">Strain Consistency Matrix</h2><p className="text-slate-500 text-[14px] font-black uppercase tracking-widest mt-3 italic leading-none">{consistencyMetric === 'yield' ? 'Yield Reliability (GPL)' : 'Quality Reliability (Flower %)'} (Lower Y is Better)</p></div>
                                <div className="flex items-center gap-4 bg-slate-900 p-2 rounded-2xl border border-slate-800">
                                    <div className="flex gap-2"><button onClick={() => setConsistencyMetric('yield')} className={`px-4 py-2 rounded-xl text-xs font-bold ${consistencyMetric === 'yield' ? 'bg-blue-600 text-white' : 'text-slate-500'}`}>Yield</button><button onClick={() => setConsistencyMetric('quality')} className={`px-4 py-2 rounded-xl text-xs font-bold ${consistencyMetric === 'quality' ? 'bg-emerald-600 text-white' : 'text-slate-500'}`}>Quality</button></div>
                                    <div className="h-6 w-px bg-slate-700"></div>
                                    <div className="flex items-center gap-2 px-2"><span className="text-[10px] font-bold text-slate-500 uppercase">Min Runs:</span><select value={minBatchCount} onChange={e => setMinBatchCount(Number(e.target.value))} className="bg-slate-950 text-white text-xs font-bold rounded-lg border border-slate-700 px-2 py-1 outline-none"><option value="2">2+</option><option value="5">5+</option><option value="10">10+</option></select></div>
                                    <div className="p-2 bg-slate-800 rounded-xl text-slate-400 ml-2"><Icons.Target /></div>
                                </div>
                            </div>
                            <div className="h-[450px] w-full">
                                <ResponsiveContainer width="100%" height="100%">
                                    <ScatterChart margin={{ top: 20, right: 40, bottom: 20, left: 20 }}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#334155" opacity={0.5} />
                                        <XAxis type="number" dataKey="x" name="Avg" unit={consistencyMetric === 'yield' ? " GPL" : "%"} domain={['auto', 'auto']} tick={{fontSize: 13, fontWeight: 900, fill: '#cbd5e1'}} label={{ value: consistencyMetric === 'yield' ? 'AVERAGE GPL' : 'AVERAGE QUALITY %', position: 'insideBottom', offset: -5, fontSize: 13, fontWeight: 900, fill: '#cbd5e1' }} />
                                        <YAxis type="number" dataKey="y" name="Consistency" domain={['auto', 'auto']} tick={{fontSize: 13, fontWeight: 900, fill: '#cbd5e1'}} label={{ value: 'VARIABILITY (STD DEV)', angle: -90, position: 'insideLeft', fontSize: 13, fontWeight: 900, fill: '#cbd5e1' }} />
                                        <Tooltip cursor={{ strokeDasharray: '3 3' }} content={({ active, payload }) => { if (active && payload && payload.length) { const d = payload[0].payload; return ( <div className="bg-slate-900 text-white p-4 rounded-2xl shadow-xl border border-slate-800 text-left"><p className="text-[13px] font-black text-emerald-400 uppercase tracking-widest mb-2">{d.name}</p><p className="text-[12px] font-bold text-slate-300">Avg: {d.x} {consistencyMetric === 'yield' ? 'GPL' : '%'}</p><p className="text-[12px] font-bold text-slate-500">+/- {d.y}</p><p className="text-[10px] mt-2 italic text-slate-600">Based on {d.count} runs</p></div> ); } return null; }} />
                                        <Scatter name="Strains" data={consistencyData}>{consistencyData.map((entry, index) => <Cell key={index} fill={entry.y < 15 ? '#10b981' : entry.y < 35 ? '#f59e0b' : '#f43f5e'} />)}</Scatter>
                                    </ScatterChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        <div className="p-11 rounded-[3.5rem] performance-card text-left">
                            <div className="flex flex-col md:flex-row md:items-center justify-between mb-12 gap-8 leading-none">
                                <div><h2 className="text-[28px] font-black italic uppercase tracking-tighter leading-none text-slate-100">Batch Strategy Map</h2><p className="text-slate-500 text-[14px] font-black uppercase tracking-widest mt-3 italic leading-none">Efficiency vs Flower Grade (Hover dots for Contextual Batch Data)</p></div>
                            </div>
                            <div className="h-[500px] w-full">
                                <ResponsiveContainer width="100%" height="100%">
                                    <ScatterChart margin={{ top: 20, right: 40, bottom: 20, left: 20 }}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#334155" opacity={0.5} />
                                        <XAxis type="number" dataKey="x" name="Efficiency" unit="GPL" domain={['auto', 'auto']} tick={{fontSize: 13, fontWeight: 900, fill: '#cbd5e1'}} label={{ value: 'GPL', position: 'insideBottom', offset: -5, fontSize: 13, fontWeight: 900, fill: '#cbd5e1' }} />
                                        <YAxis type="number" dataKey="y" name="Quality" unit="%" tick={{fontSize: 13, fontWeight: 900, fill: '#cbd5e1'}} domain={['auto', 'auto']} label={{ value: 'FLOWER %', angle: -90, position: 'insideLeft', fontSize: 13, fontWeight: 900, fill: '#cbd5e1' }} />
                                        <Tooltip cursor={{ strokeDasharray: '3 3' }} content={({ active, payload }) => { if (active && payload && payload.length) { const d = payload[0].payload; return ( <div className="bg-slate-900 text-white p-6 rounded-3xl shadow-2xl border border-slate-800 text-left min-w-[200px]"><p className="text-[13px] font-black text-emerald-400 uppercase tracking-widest mb-2">{d.name}</p><div className="space-y-1.5"><p className="text-[12px] flex justify-between gap-6 uppercase"><span className="text-slate-400 font-bold">Cycle:</span> <span className="font-bold text-white">{d.cycle}</span></p><p className="text-[12px] flex justify-between gap-6 uppercase"><span className="text-slate-400 font-bold">Room:</span> <span className="font-bold text-white">{d.room}</span></p><p className="text-[12px] flex justify-between gap-6 border-t border-white/10 pt-2 mt-2 font-black"><span className="text-slate-500 uppercase">EFFICIENCY:</span> <span className="text-blue-400">{d.x} GPL</span></p><p className="text-[12px] flex justify-between gap-6 font-black"><span className="text-slate-500 uppercase">DENSITY:</span> <span className="text-white">{d.lpl} LPL</span></p><p className="text-[12px] flex justify-between gap-6 font-black"><span className="text-slate-500 uppercase">QUALITY:</span> <span className="text-amber-400">{d.y}%</span></p></div></div> ); } return null; }} />
                                        <Scatter name="Batches" data={scatterData}>{scatterData.map((entry, index) => <Cell key={index} fill={COLORS[index % COLORS.length]} fillOpacity={0.6} />)}</Scatter>
                                        <ReferenceLine x={100} stroke="#10b981" strokeWidth={2} strokeDasharray="5 5" label={{ value: '100 GPL', position: 'top', fill: '#10b981', fontSize: 13, fontWeight: 900 }} />
                                        <ReferenceLine y={targetQuality} stroke="#f59e0b" strokeWidth={2} strokeDasharray="5 5" label={{ value: `${targetQuality}% TARGET`, position: 'right', fill: '#f59e0b', fontSize: 13, fontWeight: 900 }} />
                                    </ScatterChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        {/* HARVEST FORECASTER */}
                        <div className="p-11 rounded-[3.5rem] bg-slate-900 border border-slate-800 text-left relative overflow-hidden">
                            <div className="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-8 leading-none">
                                <div className="flex items-center gap-5"><div className="bg-emerald-600 p-4 rounded-2xl text-white shadow-lg"><Icons.Calculator /></div><div><h2 className="text-[28px] font-black italic uppercase tracking-tighter leading-none text-slate-100">Harvest Forecaster</h2><p className="text-slate-500 text-[14px] font-black uppercase tracking-widest mt-3 italic leading-none">Predictive Planning & Optimization</p></div></div>
                            </div>
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-12">
                                <div>
                                    <h3 className="text-white text-lg font-black italic uppercase tracking-tighter mb-6 flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-blue-500"></span>Single Batch Simulator</h3>
                                    <div className="space-y-6 mb-6">
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div className="space-y-2"><label className="text-[10px] font-black text-slate-500 uppercase tracking-widest block">Select Strain</label><select className="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-3 text-[13px] font-bold text-white outline-none focus:border-emerald-500 transition-all" value={forecastStrain} onChange={(e) => setForecastStrain(e.target.value)}><option value="">Choose...</option>{strainOptions.filter(s => s !== 'All').map(s => <option key={s} value={s}>{s}</option>)}</select></div>
                                            <div className="space-y-2"><label className="text-[10px] font-black text-slate-500 uppercase tracking-widest block">Light Count</label><input type="number" value={forecastLights} onChange={(e) => setForecastLights(Number(e.target.value))} className="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-3 text-[13px] font-bold text-white outline-none focus:border-emerald-500 transition-all"/></div>
                                        </div>
                                        <div className="space-y-2"><label className="text-[10px] font-black text-slate-500 uppercase tracking-widest block">Filter By Cycle (Optional)</label><MultiSelect label="Cycles" options={cycleOptions} selected={forecastCycles.length ? `${forecastCycles.length} Selected` : 'All Cycles'} onChange={(c) => { if(c === 'All') setForecastCycles([]); else if(forecastCycles.includes(c)) setForecastCycles(forecastCycles.filter(x => x !== c)); else setForecastCycles([...forecastCycles, c]); }} /></div>
                                    </div>
                                    {forecastResult ? (
                                        <div className="bg-slate-950/50 rounded-3xl p-6 border border-slate-800 grid grid-cols-2 gap-6">
                                            <div><p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Historical Avg</p><p className="text-[20px] font-black text-slate-300">{forecastResult.avgGpl} <span className="text-sm">GPL</span></p></div>
                                            <div><p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Projected Rev</p><p className="text-[20px] font-black text-white">${forecastResult.estRevenue}</p></div>
                                            <div className="col-span-2"><p className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Est. Weight Range</p><div className="flex items-center justify-between text-sm font-bold bg-slate-900 rounded-lg p-2 border border-slate-800"><span className="text-amber-500">{forecastResult.lowWt} lb</span><span className="text-slate-600">---</span><span className="text-emerald-400">{forecastResult.highWt} lb</span></div></div>
                                        </div>
                                    ) : <div className="bg-slate-950/30 rounded-3xl p-8 border border-slate-800/50 text-center text-slate-600 font-bold uppercase tracking-widest text-xs italic">Select a strain to generate prediction</div>}
                                </div>
                                <div>
                                    <div className="flex justify-between items-center mb-6"><h3 className="text-white text-lg font-black italic uppercase tracking-tighter flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-emerald-500"></span>Production Schedule Optimizer</h3><div className="flex bg-slate-950 border border-slate-700 rounded-xl p-1"><button onClick={() => setOptimizeMode('profit')} className={`px-3 py-1 text-[10px] font-bold rounded-lg transition-colors ${optimizeMode === 'profit' ? 'bg-emerald-600 text-white' : 'text-slate-500'}`}>Max Profit</button><button onClick={() => setOptimizeMode('yield')} className={`px-3 py-1 text-[10px] font-bold rounded-lg transition-colors ${optimizeMode === 'yield' ? 'bg-blue-600 text-white' : 'text-slate-500'}`}>Max Yield</button></div></div>
                                    <div className="flex items-end gap-4 mb-6"><div className="space-y-2 flex-1"><label className="text-[10px] font-black text-slate-500 uppercase tracking-widest block">Runs to Plan</label><input type="number" value={optimizeCount} onChange={(e) => setOptimizeCount(Number(e.target.value))} className="w-full bg-slate-950 border border-slate-700 rounded-xl px-4 py-3 text-[13px] font-bold text-white outline-none focus:border-emerald-500 transition-all"/></div></div>
                                    <div className="bg-slate-950/50 rounded-3xl overflow-hidden border border-slate-800">
                                        <table className="w-full text-left">
                                            <thead><tr className="bg-slate-900 text-[10px] font-black text-slate-500 uppercase tracking-widest"><th className="p-4">Rank</th><th className="p-4">Suggested Strain</th><th className="p-4 text-right">Est. {optimizeMode === 'profit' ? 'Profit' : 'Yield'}</th><th className="p-4 text-right">Metric</th></tr></thead>
                                            <tbody className="text-sm font-bold divide-y divide-slate-800">
                                                {optimizerResults.map((res, i) => (
                                                    <tr key={i} className="hover:bg-slate-800/50 transition-colors">
                                                        <td className="p-4 text-slate-500">#{i+1}</td>
                                                        <td className="p-4 text-emerald-400">{res.name}</td>
                                                        <td className="p-4 text-right text-white">{optimizeMode === 'profit' ? `$${res.estProfit}` : `${res.avgGpl} GPL`}</td>
                                                        <td className="p-4 text-right text-blue-400">{optimizeMode === 'profit' ? `${res.roi}% ROI` : `${res.avgRatioA}% A`}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                        {optimizerResults.length === 0 && <div className="p-6 text-center text-slate-600 text-xs font-bold uppercase">Not enough data to optimize</div>}
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* FACILITY LEADERBOARD */}
                        <div className="p-14 rounded-[3.5rem] performance-card text-left relative overflow-hidden">
                            <div className="flex flex-col md:flex-row md:items-center justify-between mb-12 leading-none gap-8">
                                <div><h2 className="text-[28px] font-black italic uppercase tracking-tighter leading-none text-slate-100">Facility Power Leaderboard</h2><p className="text-slate-500 text-[13px] font-black uppercase tracking-widest mt-3 italic leading-none">Room Rankings by Operational Performance Score</p></div>
                                <div className="flex items-center gap-2 bg-slate-800 p-2 rounded-2xl border border-slate-700 shadow-sm"><span className="text-[12px] font-black text-slate-400 uppercase px-4 tracking-widest">Sort Strategy:</span><button onClick={() => setLeaderboardSort('gpl')} className={`px-6 py-2.5 text-[13px] font-black uppercase rounded-xl transition-all ${leaderboardSort === 'gpl' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-500 hover:bg-white'}`}>GPL (Weight)</button><button onClick={() => setLeaderboardSort('mix')} className={`px-6 py-2.5 text-[13px] font-black uppercase rounded-xl transition-all ${leaderboardSort === 'mix' ? 'bg-emerald-600 text-white shadow-md' : 'text-slate-500 hover:bg-white'}`}>Mix (Grade)</button></div>
                            </div>
                            <div className="h-[500px] w-full">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart layout="vertical" data={roomBenchmark} margin={{ left: 50, right: 120 }}>
                                        <CartesianGrid strokeDasharray="3 3" horizontal={false} stroke="#334155" opacity={0.3} />
                                        <XAxis type="number" domain={['auto', 'auto']} tick={{fontSize: 12, fontWeight: 900, fill: '#64748b'}} />
                                        <YAxis dataKey="name" type="category" tick={{fontSize: 17, fontStyle: 'italic', fontWeight: 900, fill: '#f1f5f9'}} width={100} axisLine={false} tickLine={false} />
                                        <Tooltip cursor={{fill: 'rgba(255,255,255,0.05)'}} content={({active, payload}) => { if (active && payload && payload.length) { const d = payload[0].payload; return ( <div className="bg-slate-900 text-white p-6 rounded-[2rem] shadow-2xl border border-slate-800 min-w-[240px] text-left"><div className="flex items-center gap-3 mb-3 border-b border-white/10 pb-3 leading-none"><Icons.Crown /><p className="text-sm font-black uppercase tracking-widest">{d.name}</p></div><div className="space-y-2 leading-none mt-4"><p className="text-[13px] flex justify-between gap-6 uppercase"><span className="text-slate-400 font-bold tracking-widest">Efficiency:</span> <span className="font-black text-blue-400">{d.gpl} GPL</span></p><p className="text-[13px] flex justify-between gap-6 uppercase"><span className="text-slate-400 font-bold tracking-widest">Quality:</span> <span className="font-black text-emerald-400">{d.mix}%</span></p></div></div> ); } return null; }}/>
                                        <ReferenceLine x={100} stroke="#10b981" strokeDasharray="5 5" label={{ value: 'GOAL: 100 GPL', position: 'top', fill: '#10b981', fontSize: 13, fontWeight: 900 }} />
                                        <Bar dataKey="sortVal" name="Score" radius={[0, 20, 20, 0]} barSize={50}>{roomBenchmark.map((entry, i) => ( <Cell key={i} fill={ i === 0 ? '#10b981' : entry.sortVal > (leaderboardSort === 'mix' ? 75 : 90) ? '#3b82f6' : entry.sortVal > (leaderboardSort === 'mix' ? 50 : 60) ? '#f59e0b' : '#f43f5e' } /> ))}</Bar>
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        {/* CYCLE BREAKDOWN LIST */}
                        <div className="p-11 rounded-[3.5rem] performance-card text-left relative overflow-hidden mb-8">
                            <div className="flex flex-col md:flex-row md:items-center justify-between mb-10 gap-8 leading-none">
                                <div className="flex items-center gap-5"><div className="bg-blue-500/10 p-4 rounded-2xl text-blue-500"><Icons.List /></div><div><h2 className="text-[28px] font-black italic uppercase tracking-tighter leading-none text-slate-100">Cycle History Detail</h2><p className="text-slate-500 text-[14px] font-black uppercase tracking-widest mt-3 italic leading-none">Expand cycles to view individual room performance</p></div></div>
                            </div>
                            <div className="space-y-4">
                                {cycleBreakdown.map(cycle => (
                                    <div key={cycle.id} className="bg-slate-900/50 border border-slate-800 rounded-3xl overflow-hidden transition-all hover:border-slate-700">
                                        <div onClick={() => setExpandedCycle(expandedCycle === cycle.id ? null : cycle.id)} className="p-6 flex flex-wrap items-center justify-between cursor-pointer group hover:bg-slate-800/50 transition-colors">
                                            <div className="flex items-center gap-6">
                                                <div className={`p-3 rounded-xl transition-colors ${expandedCycle === cycle.id ? 'bg-emerald-600 text-white' : 'bg-slate-800 text-slate-400 group-hover:text-white'}`}><Icons.Chevron /></div>
                                                <div><p className="text-[12px] font-black text-slate-500 uppercase tracking-widest">Cycle</p><h3 className="text-[24px] font-black text-slate-200">{cycle.id}</h3></div>
                                            </div>
                                            <div className="flex items-center gap-8 md:gap-16">
                                                <div className="text-right"><p className="text-[11px] font-black text-slate-500 uppercase tracking-widest mb-1">Flower Yield</p><p className="text-[18px] font-black text-emerald-400">{cycle.flowerLb} lb</p></div>
                                                <div className="text-right"><p className="text-[11px] font-black text-slate-500 uppercase tracking-widest mb-1">Total Yield</p><p className="text-[18px] font-black text-slate-200">{cycle.yieldLb} lb</p></div>
                                                <div className="text-right"><p className="text-[11px] font-black text-slate-500 uppercase tracking-widest mb-1">Avg Efficiency</p><p className={`text-[18px] font-black ${cycle.gpl >= 100 ? 'text-emerald-400' : 'text-blue-400'}`}>{cycle.gpl} GPL</p></div>
                                                <div className="text-right hidden sm:block"><p className="text-[11px] font-black text-slate-500 uppercase tracking-widest mb-1">Avg Quality</p><p className={`text-[18px] font-black ${cycle.quality >= targetQuality ? 'text-emerald-400' : 'text-amber-500'}`}>{cycle.quality}%</p></div>
                                                <div className={`transform transition-transform duration-300 text-slate-500 ${expandedCycle === cycle.id ? 'rotate-180' : ''}`}><Icons.Chevron /></div>
                                            </div>
                                        </div>
                                        {expandedCycle === cycle.id && (
                                            <div className="border-t border-slate-800 bg-slate-950/30 p-6 animate-in slide-in-from-top-2 duration-200">
                                                <div className="mb-8"><h4 className="text-[13px] font-black text-slate-400 uppercase tracking-widest mb-3">Strain Totals</h4>
                                                    <SortableTable 
                                                        columns={[
                                                            { key: 'name', label: 'Strain', align: 'left', color: () => 'text-emerald-400' },
                                                            { key: 'flowerLb', label: 'Flower Yield', align: 'right', format: v => `${v} lb`, color: () => 'text-emerald-300', isNumeric: true },
                                                            { key: 'yieldLb', label: 'Total Yield', align: 'right', format: v => `${v} lb`, isNumeric: true },
                                                            { key: 'gpl', label: 'Avg Eff', align: 'right', format: v => `${v} GPL`, color: () => 'text-blue-400', isNumeric: true },
                                                            { key: 'quality', label: 'Avg Quality', align: 'right', format: v => `${v}%`, color: () => 'text-amber-500', isNumeric: true }
                                                        ]}
                                                        data={cycle.strainsAgg}
                                                    />
                                                </div>
                                                <div className="mb-8"><h4 className="text-[13px] font-black text-slate-400 uppercase tracking-widest mb-3">Room Totals</h4>
                                                    <SortableTable 
                                                        columns={[
                                                            { key: 'name', label: 'Room', align: 'left', color: () => 'text-white' },
                                                            { key: 'strains', label: 'Strain(s)', align: 'left', color: () => 'text-slate-400 text-[11px]' },
                                                            { key: 'flowerLb', label: 'Flower Yield', align: 'right', format: v => `${v} lb`, color: () => 'text-emerald-300', isNumeric: true },
                                                            { key: 'yieldLb', label: 'Total Yield', align: 'right', format: v => `${v} lb`, isNumeric: true },
                                                            { key: 'gpl', label: 'Avg Eff', align: 'right', format: v => `${v} GPL`, color: () => 'text-blue-400', isNumeric: true },
                                                            { key: 'quality', label: 'Avg Quality', align: 'right', format: v => `${v}%`, color: () => 'text-amber-500', isNumeric: true }
                                                        ]}
                                                        data={cycle.roomsAgg}
                                                    />
                                                </div>
                                                <div><h4 className="text-[13px] font-black text-slate-400 uppercase tracking-widest mb-3">Batch Details</h4>
                                                    <SortableTable 
                                                        columns={[
                                                            { key: 'id', label: 'Room', align: 'left', color: () => 'text-white' },
                                                            { key: 'strain', label: 'Strain', align: 'left', color: () => 'text-emerald-400' },
                                                            { key: 'flowerLb', label: 'Flower Yield', align: 'right', format: v => `${v} lb`, color: () => 'text-emerald-300', isNumeric: true },
                                                            { key: 'yieldLb', label: 'Total Yield', align: 'right', format: v => `${v} lb`, color: () => 'text-slate-500', isNumeric: true },
                                                            { key: 'gpl', label: 'Efficiency', align: 'right', format: v => `${v} GPL`, color: () => 'text-blue-400', isNumeric: true },
                                                            { key: 'quality', label: 'Flower Ratio', align: 'right', format: v => `${v}%`, color: () => 'text-amber-500', isNumeric: true }
                                                        ]}
                                                        data={cycle.rooms}
                                                    />
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* SETTINGS MODAL */}
                    {showSettingsModal && (
                        <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-xl z-[300] flex items-center justify-center p-4">
                            <div className="bg-slate-900 border border-slate-800 rounded-[2.5rem] w-full max-w-4xl max-h-[90vh] overflow-hidden shadow-2xl relative animate-in fade-in zoom-in duration-300 flex flex-col">
                                <div className="p-8 border-b border-slate-800 flex justify-between items-center bg-slate-900 z-10">
                                    <h2 className="text-2xl font-black text-white italic uppercase tracking-tighter">Configuration</h2>
                                    <button onClick={() => setShowSettingsModal(false)} className="bg-slate-800 hover:bg-slate-700 p-3 rounded-2xl text-slate-400 hover:text-white transition-colors"><Icons.X /></button>
                                </div>
                                <div className="p-8 overflow-y-auto custom-scrollbar flex-1 grid grid-cols-1 md:grid-cols-2 gap-12">
                                    {/* Left Col: Pricing */}
                                    <div className="space-y-8">
                                        <div className="flex items-center gap-3 mb-2 text-emerald-500"><Icons.Coins /><h3 className="text-sm font-black uppercase tracking-widest">Base Market Pricing</h3></div>
                                        <div className="bg-slate-950/50 p-6 rounded-3xl border border-slate-800 space-y-4">
                                            {[{l: 'Flower (A)', k: 'flowerA'}, {l: 'Smalls (B)', k: 'smallsB'}, {l: 'Trim (C)', k: 'trimC'}].map(p => (
                                                <div key={p.k} className="flex justify-between items-center"><span className="text-xs font-bold text-slate-400 uppercase">{p.l}</span><div className="flex items-center bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 w-28 focus-within:border-emerald-500"><span className="text-slate-500 text-xs mr-2">$</span><input type="number" step="0.01" value={prices[p.k]} onChange={e => setPrices({...prices, [p.k]: parseFloat(e.target.value)})} className="bg-transparent text-white font-mono font-bold w-full outline-none text-right" /></div></div>
                                            ))}
                                        </div>

                                        <div className="flex items-center gap-3 mb-2 text-purple-400"><Icons.Zap /><h3 className="text-sm font-black uppercase tracking-widest">Extracts & Products</h3></div>
                                        <div className="bg-slate-950/50 p-6 rounded-3xl border border-slate-800 space-y-4">
                                            {[{l: 'BHO ($/g)', k: 'bho'}, {l: 'Rosin ($/g)', k: 'rosin'}, {l: 'Carts ($/ea)', k: 'cart'}, {l: 'Pre-Rolls ($/ea)', k: 'preroll'}].map(p => (
                                                <div key={p.k} className="flex justify-between items-center"><span className="text-xs font-bold text-slate-400 uppercase">{p.l}</span><div className="flex items-center bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 w-28 focus-within:border-purple-500"><span className="text-slate-500 text-xs mr-2">$</span><input type="number" step="0.01" value={prices[p.k]} onChange={e => setPrices({...prices, [p.k]: parseFloat(e.target.value)})} className="bg-transparent text-white font-mono font-bold w-full outline-none text-right" /></div></div>
                                            ))}
                                        </div>

                                        <div className="flex items-center gap-3 mb-2 text-white"><Icons.Star /><h3 className="text-sm font-black uppercase tracking-widest">Strain Pricing Overrides</h3></div>
                                        <div className="bg-slate-950/50 p-6 rounded-3xl border border-slate-800 space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
                                            {strainOptions.filter(s => s !== 'All').map(s => (
                                                <div key={s} className="flex justify-between items-center border-b border-slate-800/50 pb-2 mb-2 last:border-0"><span className="text-xs font-bold text-emerald-400 truncate w-32">{s}</span><div className="flex items-center bg-slate-900 border border-slate-700 rounded-lg px-2 py-1 w-24"><span className="text-slate-500 text-[10px] mr-1">$</span><input type="number" step="0.01" placeholder={prices.flowerA} value={strainPrices[s] || ''} onChange={e => updateStrainPrice(s, e.target.value)} className="bg-transparent text-white font-mono text-xs font-bold w-full outline-none text-right" /></div></div>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Right Col: Expenses & Goals */}
                                    <div className="space-y-8">
                                        <div className="flex items-center gap-3 mb-2 text-rose-500"><Icons.TrendingUp /><h3 className="text-sm font-black uppercase tracking-widest">Operational Expenses</h3></div>
                                        <div className="bg-slate-950/50 p-6 rounded-3xl border border-slate-800 space-y-4">
                                            <div className="flex justify-between items-center pb-4 border-b border-slate-800">
                                                <span className="text-xs font-bold text-slate-400 uppercase">Active Light Count</span>
                                                <input type="number" value={totalActiveLights} onChange={e => setTotalActiveLights(Number(e.target.value))} className="bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 w-24 text-white font-bold text-right outline-none focus:border-rose-500"/>
                                            </div>
                                            <div className="space-y-3 max-h-64 overflow-y-auto custom-scrollbar pr-2">
                                                {expenses.map(exp => (
                                                    <div key={exp.id} className="flex items-center gap-3">
                                                        <button onClick={() => removeExpense(exp.id)} className="text-slate-600 hover:text-rose-500"><Icons.Trash /></button>
                                                        <input type="text" value={exp.name} onChange={e => updateExpense(exp.id, 'name', e.target.value)} className="bg-transparent border-b border-slate-700 text-xs font-bold text-slate-300 w-full outline-none focus:border-rose-500 py-1" />
                                                        <div className="flex items-center bg-slate-900 border border-slate-700 rounded-lg px-2 py-1 w-24"><span className="text-slate-500 text-[10px] mr-1">$</span><input type="number" value={exp.val} onChange={e => updateExpense(exp.id, 'val', parseFloat(e.target.value))} className="bg-transparent text-white font-mono text-xs font-bold w-full outline-none text-right" /></div>
                                                    </div>
                                                ))}
                                                <button onClick={addExpense} className="text-xs font-bold text-emerald-500 hover:text-emerald-400 flex items-center gap-1 mt-2">+ Add Item</button>
                                            </div>
                                            <div className="pt-4 border-t border-slate-800 flex justify-between items-center">
                                                <span className="text-xs font-black text-rose-400 uppercase tracking-widest">Est. OpEx / Light</span>
                                                <span className="text-xl font-black text-white">${computedOpexPerLight}</span>
                                            </div>
                                        </div>

                                        <div className="flex items-center gap-3 mb-2 text-amber-500"><Icons.Award /><h3 className="text-sm font-black uppercase tracking-widest">Performance Goals</h3></div>
                                        <div className="bg-slate-950/50 p-6 rounded-3xl border border-slate-800">
                                            <div className="flex justify-between items-center">
                                                <span className="text-xs font-bold text-slate-400 uppercase">Target Flower Ratio</span>
                                                <div className="flex items-center bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 w-24 focus-within:border-amber-500"><input type="number" value={targetQuality} onChange={e => setTargetQuality(parseInt(e.target.value))} className="bg-transparent text-white font-mono font-bold w-full outline-none text-right" /><span className="text-slate-500 text-xs ml-1">%</span></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="p-6 border-t border-slate-800 bg-slate-900 z-10 flex justify-end">
                                    <button onClick={() => setShowSettingsModal(false)} className="bg-emerald-600 hover:bg-emerald-500 text-white font-black uppercase px-8 py-4 rounded-2xl transition-all shadow-lg text-sm">Save Configuration</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {showEntryModal && (
                        <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-xl z-[300] flex items-center justify-center p-4">
                            <div className="bg-white rounded-[3.5rem] w-full max-w-5xl h-[92vh] overflow-hidden shadow-2xl relative animate-in fade-in zoom-in duration-300">
                                <div className="absolute top-8 right-8 z-10">
                                    <button onClick={() => setShowEntryModal(false)} className="bg-slate-100 hover:bg-slate-200 p-4 rounded-3xl text-slate-500 transition-colors shadow-sm"><Icons.X /></button>
                                </div>
                                <iframe src={SYSTEM_CONFIG.ENTRY_FORM_LINK} className="w-full h-full border-none" title="Production Entry Form">Loading form...</iframe>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
